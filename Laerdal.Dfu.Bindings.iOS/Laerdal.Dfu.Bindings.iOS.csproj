<Project Sdk="Microsoft.NET.Sdk">
    <PropertyGroup>
        <Laerdal_Package_Name>Laerdal.Dfu.Bindings.iOS</Laerdal_Package_Name>
        <Laerdal_Package_Tags>Ble;Tools;Xamarin;Dfu;Bluetooth;Nordic;Semiconductor</Laerdal_Package_Tags>
        <Laerdal_Package_Copyright>Laerdal Medical, Francois Raminosona</Laerdal_Package_Copyright>
        <Laerdal_Package_Description>Xamarin wrapper around Nordic.Dfu for iOS.</Laerdal_Package_Description>
    
        <Nordic_Package_Version>4.11.1</Nordic_Package_Version>
        <BuildWithMSBuildOnMono>false</BuildWithMSBuildOnMono>
    </PropertyGroup>

    <PropertyGroup>
        <TargetFrameworks>net6.0-ios;net7.0-ios</TargetFrameworks>

        <MtouchExtraArgs>-v -v -v -v</MtouchExtraArgs>
        
        <AllowUnsafeBlocks>true</AllowUnsafeBlocks>
        <MtouchNoSymbolStrip>true</MtouchNoSymbolStrip>
        <Optimize>false</Optimize>
        <NoBindingEmbedding>false</NoBindingEmbedding>
        <!-- warning CS0114: 'LegacyDFUServiceInitiator.StartWithTargetWithIdentifier(NSUuid)' hides inherited member 'DFUServiceInitiator.StartWithTargetWithIdentifier(NSUuid)'. To make the current member override that implementation, add the override keyword. Otherwise add the new keyword. -->
        <!-- warning CS0114: 'SecureDFUServiceInitiator.StartWithTargetWithIdentifier(NSUuid)' hides inherited member 'DFUServiceInitiator.StartWithTargetWithIdentifier(NSUuid)'. To make the current member override that implementation, add the override keyword. Otherwise add the new keyword. -->
        <NoWarn>CS0114</NoWarn>
    </PropertyGroup>

    <Import Project="Laerdal.targets" />

    <ItemGroup>
        <ObjcBindingApiDefinition Include="ApiDefinition.cs" />
        <ObjcBindingCoreSource Include="StructsAndEnums.cs" />

        <Compile Remove="Sharpie/**/*.cs" />
        <None Include="Sharpie/**/*.cs" />
    </ItemGroup>

    <Target Name="_DownloadIosNativeFiles" BeforeTargets="BeforeCompile" Condition="!Exists('Carthage\Carthage\Build\iOSDFULibrary.xcframework')">
        
        <Message Importance="High" Text="GITHUB_ACCESS_TOKEN: $(GITHUB_ACCESS_TOKEN)" />
        <WriteLinesToFile File="Carthage\Cartfile" Lines="github &quot;NordicSemiconductor/IOS-Pods-DFU-Library&quot; &quot;4.11.1&quot;" Overwrite="true" />
        <Exec WorkingDirectory="Carthage\" Command="carthage update --use-xcframeworks --platform iOS" EnvironmentVariables="GITHUB_ACCESS_TOKEN=$(GITHUB_ACCESS_TOKEN)" />
    </Target>
    <Target Name="_RunOjectiveSharpie" AfterTargets="_DownloadIosNativeFiles" BeforeTargets="BeforeCompile" Condition="Exists('Carthage\Carthage\Build\iOSDFULibrary.xcframework') AND !Exists('Sharpie\') AND !$(ContinuousIntegrationBuild)">
        <Exec Command="sharpie bind -o Sharpie --namespace=Laerdal.Dfu.Bindings.iOS -f Carthage/Carthage/Build/iOSDFULibrary.xcframework/ios-arm64/iOSDFULibrary.framework" />
    </Target>

    <ItemGroup>
        <!-- Frameworks\iOSDFULibrary.framework -->
        <NativeReference Include="Carthage\Carthage\Build\iOSDFULibrary.xcframework">
            <Kind>Framework</Kind>
            <SmartLink>False</SmartLink>
            <Frameworks>Foundation</Frameworks>
        </NativeReference>
        
        <!-- Frameworks\ZIPFoundation.framework -->
        <NativeReference Include="Carthage\Carthage\Build\ZIPFoundation.xcframework">
            <Kind>Framework</Kind>
            <SmartLink>False</SmartLink>
            <Frameworks>Foundation</Frameworks>
        </NativeReference>
    </ItemGroup>

    <ItemGroup>
      <PackageReference Include="Xamarin.iOS.SwiftRuntimeSupport" Version="0.2.1" />
      <PackageReference Include="Xamarin.Swift" Version="1.0.11" />
    </ItemGroup>
</Project>
